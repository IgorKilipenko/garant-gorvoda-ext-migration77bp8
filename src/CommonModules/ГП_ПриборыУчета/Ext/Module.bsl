// Гарант+ Килипенко 11.09.2024 [F00227694] Доработка документа ввод показаний счетчика ++
#Область ПрограммныйИнтерфейс

// Параметры:
//  ЛицевойСчет - СправочникСсылка.КВП_ЛицевыеСчета
//  ТолькоДействующиеСчетчики - Булево, Неопределено - По умолчанию Истина
//  ТолькоДействующиеУслуги - Булево, Неопределено - По умолчанию Истина
// Возвращаемое значение:
//  - ТаблицаЗначений
//      * Объект - СправочникСсылка.КВП_ЛицевыеСчета
//      * ПриборУчета - СправочникСсылка.КВП_Счетчики
//      * Организация - СправочникСсылка.Организации
//      * Действует - Булево
//      * ДатаНачала - Дата
//      * ДатаПоверки - Дата
//      * НомерПломбы - Строка
//      * ПричинаОтключения - ПеречислениеСсылка.УПЖКХ_ПричиныОтключенияПриборовУчета
//      * Услуга - ПеречислениеСсылка.КВП_Услуги
//      * УслугаДействует - Булево
Функция ПолучитьПриборыУчетаДоговораПоЛицевомуСчету(
    Знач ЛицевойСчет, Знач ТолькоДействующиеСчетчики = Неопределено, ТолькоДействующиеУслуги = Неопределено) Экспорт

    ТолькоДействующиеСчетчики = ?(ТолькоДействующиеСчетчики = Неопределено, Истина, ТолькоДействующиеСчетчики);
    ТолькоДействующиеУслуги = ?(ТолькоДействующиеУслуги = Неопределено, Истина, ТолькоДействующиеУслуги);

    Запрос = Новый Запрос;
    Запрос.Текст =
        "ВЫБРАТЬ РАЗРЕШЕННЫЕ
        |	СведенияДляВзаиморасчетовПоЛС.Договор КАК Договор,
        |	СведенияДляВзаиморасчетовПоЛС.Организация КАК Организация,
        |	СведенияДляВзаиморасчетовПоЛС.Контрагент КАК Контрагент
        |ПОМЕСТИТЬ ВТ_ДоговорыЛС
        |ИЗ
        |	РегистрСведений.УПЖКХ_СведенияДляВзаиморасчетовПоЛС.СрезПоследних(, ЛицевойСчет = &ЛицевойСчет) КАК СведенияДляВзаиморасчетовПоЛС
        |ГДЕ
        |	СведенияДляВзаиморасчетовПоЛС.ЛицевойСчет = &ЛицевойСчет
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
        |	СведенияДляВзаиморасчетовПоЛС.Период КАК Период,
        |	СведенияДляВзаиморасчетовПоЛС.Регистратор КАК Регистратор,
        |	СведенияДляВзаиморасчетовПоЛС.Организация КАК Организация,
        |	СведенияДляВзаиморасчетовПоЛС.ЛицевойСчет КАК ЛицевойСчет,
        |	СведенияДляВзаиморасчетовПоЛС.Договор КАК Договор,
        |	СведенияДляВзаиморасчетовПоЛС.Контрагент КАК Контрагент
        |ПОМЕСТИТЬ ВТ_ЛицевыеСчетаДоговора
        |ИЗ
        |	РегистрСведений.УПЖКХ_СведенияДляВзаиморасчетовПоЛС.СрезПоследних КАК СведенияДляВзаиморасчетовПоЛС
        |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ДоговорыЛС КАК ВТ_ДоговорыЛС
        |		ПО СведенияДляВзаиморасчетовПоЛС.Договор = ВТ_ДоговорыЛС.Договор
        |			И СведенияДляВзаиморасчетовПоЛС.Контрагент = ВТ_ДоговорыЛС.Контрагент
        |			И СведенияДляВзаиморасчетовПоЛС.Организация = ВТ_ДоговорыЛС.Организация
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ РАЗРЕШЕННЫЕ
        |	ИсторияСостоянийПриборовУчета.Период КАК Период,
        |	ИсторияСостоянийПриборовУчета.Регистратор КАК Регистратор,
        |	ИсторияСостоянийПриборовУчета.Объект КАК Объект,
        |	ИсторияСостоянийПриборовУчета.ПриборУчета КАК ПриборУчета,
        |	ИсторияСостоянийПриборовУчета.Действует КАК Действует,
        |	ИсторияСостоянийПриборовУчета.ДатаНачала КАК ДатаНачала,
        |	ИсторияСостоянийПриборовУчета.ДатаПоверки КАК ДатаПоверки,
        |	ИсторияСостоянийПриборовУчета.НомерПломбы КАК НомерПломбы,
        |	ИсторияСостоянийПриборовУчета.ПричинаОтключения КАК ПричинаОтключения
        |ПОМЕСТИТЬ ВТ_ИсторияСостоянийПриборовУчета
        |ИЗ
        |	РегистрСведений.УПЖКХ_ИсторияСостоянийПриборовУчета.СрезПоследних КАК ИсторияСостоянийПриборовУчета
        |ГДЕ
        |	ИсторияСостоянийПриборовУчета.Объект В
        |			(ВЫБРАТЬ
        |				ВТ_ЛицевыеСчетаДоговора.ЛицевойСчет
        |			ИЗ
        |				ВТ_ЛицевыеСчетаДоговора)
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ РАЗРЕШЕННЫЕ
        |	ВТ_ИсторияСостоянийПриборовУчета.Период КАК ПериодСчетчика,
        |	НазначенныеНачисления.Организация КАК Организация,
        |	ВТ_ИсторияСостоянийПриборовУчета.Объект КАК Объект,
        |	ВТ_ИсторияСостоянийПриборовУчета.ПриборУчета КАК ПриборУчета,
        |	ВТ_ИсторияСостоянийПриборовУчета.Действует КАК СчетчикДействует,
        |	ВТ_ИсторияСостоянийПриборовУчета.ДатаНачала КАК ДатаНачала,
        |	ВТ_ИсторияСостоянийПриборовУчета.ДатаПоверки КАК ДатаПоверки,
        |	ВТ_ИсторияСостоянийПриборовУчета.НомерПломбы КАК НомерПломбы,
        |	ВТ_ИсторияСостоянийПриборовУчета.ПричинаОтключения КАК ПричинаОтключения,
        |	НазначенныеНачисления.Услуга КАК Услуга,
        |	НазначенныеНачисления.Действует КАК УслугаДействует,
        |	НазначенныеНачисления.ДатаИзменения КАК ДатаИзменения
        |ИЗ
        |	ВТ_ИсторияСостоянийПриборовУчета КАК ВТ_ИсторияСостоянийПриборовУчета
        |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.КВП_НазначенныеНачисления.СрезПоследних КАК НазначенныеНачисления
        |		ПО ВТ_ИсторияСостоянийПриборовУчета.Объект = НазначенныеНачисления.Объект
        |			И ВТ_ИсторияСостоянийПриборовУчета.ПриборУчета.ВидУслуги = НазначенныеНачисления.Услуга
        |			И (НазначенныеНачисления.Действует = ИСТИНА)
        |";

    Запрос.УстановитьПараметр("ЛицевойСчет", ЛицевойСчет);
    Если ТолькоДействующиеСчетчики = Ложь Тогда
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "И ИсторияСостоянийПриборовУчета.Действует = ИСТИНА", "");
    КонецЕсли;
    Если ТолькоДействующиеУслуги = Ложь Тогда
        Запрос.Текст = СтрЗаменитьПоРегулярномуВыражению(Запрос.Текст, "И\s+\(?НазначенныеНачисления.Действует = ИСТИНА\)?", "");
    КонецЕсли;

    РезультатЗапроса = Запрос.Выполнить();
    РезультатФункции = РезультатЗапроса.Выгрузить();

    Возврат РезультатФункции;
КонецФункции

#КонецОбласти // ПрограммныйИнтерфейс
// Гарант+ Килипенко 11.09.2024 [F00227694] Доработка документа ввод показаний счетчика --
